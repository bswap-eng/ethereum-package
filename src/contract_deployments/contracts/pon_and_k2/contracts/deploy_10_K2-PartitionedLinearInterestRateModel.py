from web3 import Web3
from web3.middleware import construct_sign_and_send_raw_middleware
import os
import time
import logging

# Account Alias: PON
ACCOUNT_ALIAS = "PON"

# PartitionedLinearInterestRateModel contract bytecode
BYTE_CODE = "0x60806040523480156200001157600080fd5b506040516200122e3803806200122e833981016040819052620000349162000227565b6200003f3362000061565b62000052898989898989898989620000b1565b50505050505050505062000291565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b88881015620001165760405162461bcd60e51b815260206004820152602660248201527f426173652052617465205261792065786365656473204f7074696d616c20526160448201526574652052617960d01b60648201526084015b60405180910390fd5b87871015620001765760405162461bcd60e51b815260206004820152602560248201527f4f7074696d616c2072617465205261792065786365656473204d617820526174604482015264652052617960d81b60648201526084016200010d565b600754821015620001b95760405162461bcd60e51b815260206004820152600c60248201526b54203e3d206d61785261746560a01b60448201526064016200010d565b848411620001f25760405162461bcd60e51b815260206004820152600560248201526426901f102760d91b60448201526064016200010d565b600598909855600696909655600794909455600892909255600a94909455600193909355600292909255600391909155600455565b60008060008060008060008060006101208a8c0312156200024757600080fd5b8951985060208a0151975060408a0151965060608a0151955060808a0151945060a08a0151935060c08a0151925060e08a015191506101008a015190509295985092959850929598565b610f8d80620002a16000396000f3fe608060405234801561001057600080fd5b50600436106101375760003560e01c80636617dc85116100b8578063770f6ab51161007c578063770f6ab5146102495780638b8fbd92146102525780638da5cb5b1461025b578063c9e525df1461026c578063e1519c6514610275578063f2fde38b1461027e57600080fd5b80636617dc85146101ff578063693f917e14610212578063715018a61461021b578063735816dd14610223578063736a6d371461023657600080fd5b80635cdcd4ff116100ff5780635cdcd4ff146101b45780635e05f30f146101c7578063620e33e0146101da578063646bcede146101e35780636589efdf146101f657600080fd5b8063134169dd1461013c578063180fde071461016c5780632bc80f3a146101815780633b307ec3146101985780633c15f91c146101ab575b600080fd5b60095461014f906001600160a01b031681565b6040516001600160a01b0390911681526020015b60405180910390f35b61017f61017a366004610dd4565b610291565b005b61018a60045481565b604051908152602001610163565b61018a6101a6366004610dfd565b61034a565b61018a60085481565b61018a6101c2366004610e29565b6103c9565b61018a6101d5366004610dfd565b6105e2565b61018a600a5481565b61018a6101f1366004610e29565b6106c5565b61018a60075481565b61018a61020d366004610e29565b610867565b61018a60025481565b61017f610a81565b61017f610231366004610e64565b610a95565b61018a610244366004610dfd565b610ab9565b61018a60065481565b61018a60035481565b6000546001600160a01b031661014f565b61018a60015481565b61018a60055481565b61017f61028c366004610dd4565b610ada565b610299610b53565b6001600160a01b0381166102e15760405162461bcd60e51b81526004016102d8906020808252600490820152635a65726f60e01b604082015260600190565b60405180910390fd5b6009546001600160a01b0316156103285760405162461bcd60e51b815260206004820152600b60248201526a105b1c9958591e481cd95d60aa1b60448201526064016102d8565b600980546001600160a01b0319166001600160a01b0392909216919091179055565b6000806103588585856105e2565b90506000600254600261036b9190610ed9565b905080676765c793fa10079d601b1b600354676765c793fa10079d601b1b87866103959190610ed9565b61039f9190610ef6565b6103a99190610ed9565b6103b39190610ef6565b6103bd9190610ef6565b925050505b9392505050565b6000806103d78787876105e2565b905060006007546004546103eb9190610f18565b9050600060025460026103fe9190610ed9565b9050600060015460026104119190610ed9565b9050600082676765c793fa10079d601b1b600354676765c793fa10079d601b1b8c8961043d9190610ed9565b6104479190610ef6565b6104519190610ed9565b61045b9190610ef6565b6104659190610ef6565b9050600082676765c793fa10079d601b1b600354676765c793fa10079d601b1b8d8a6104919190610ed9565b61049b9190610ef6565b6104a59190610ed9565b6104af9190610ef6565b6104b99190610ef6565b9050818911156105205760405162461bcd60e51b815260206004820152602c60248201527f496e76616c6964206d6178696d756d20736c61736861626c6520616d6f756e7460448201526b20706572206c6976656e737360a01b60648201526084016102d8565b808811156105885760405162461bcd60e51b815260206004820152602f60248201527f496e76616c6964206d6178696d756d20736c61736861626c6520616d6f756e7460448201526e103832b91031b7b9393ab83a34b7b760891b60648201526084016102d8565b610593816002610ed9565b61059d9089610ef6565b6105a8836002610ed9565b6105b2908b610ef6565b6105bc9190610f2b565b6105c69086610ed9565b6105d09087610f2b565b96505050505050505b95945050505050565b6000836000036105f557506005546103c2565b836106008385610f2b565b61061590676765c793fa10079d601b1b610ed9565b61061f9190610ef6565b9050600854811015610667576008548160055460065461063f9190610f18565b6106499190610ed9565b6106539190610ef6565b6005546106609190610f2b565b90506103c2565b60085461067f90676765c793fa10079d601b1b610f18565b60085461068c9083610f18565b60065460075461069c9190610f18565b6106a69190610ed9565b6106b09190610ef6565b6006546106bd9190610f2b565b949350505050565b600080600960009054906101000a90046001600160a01b03166001600160a01b031663c07d30ff6040518163ffffffff1660e01b8152600401602060405180830381865afa15801561071b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061073f9190610f3e565b9050676765c793fa10079d601b1b600a548261075b9190610ed9565b6107659190610ef6565b90506000600960009054906101000a90046001600160a01b03166001600160a01b031663d3d3b3eb6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156107bc573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107e09190610f3e565b90506107ec8882610f2b565b82101561080c5760405163cc3bab8f60e01b815260040160405180910390fd5b600061082d61081b898b610f2b565b846108268b86610f18565b8a8a610bad565b9050676765c793fa10079d601b1b6108458683610ed9565b61084f9190610ef6565b61085a906001610f2b565b9998505050505050505050565b600080600960009054906101000a90046001600160a01b03166001600160a01b031663c07d30ff6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156108bd573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108e19190610f3e565b9050676765c793fa10079d601b1b600a54826108fd9190610ed9565b6109079190610ef6565b9050600080600190506000600960009054906101000a90046001600160a01b03166001600160a01b031663e812064f6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610965573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109899190610f3e565b905060006109978286610f18565b90505b806109a6846001610f2b565b1015610a605760026109b88285610f2b565b6109c29190610ef6565b95506109e36109d18b88610f2b565b866109dc8d86610f18565b8c8c610bdf565b6109ef5785925061099a565b6000676765c793fa10079d601b1b88610a1f610a0b8e8b610f2b565b898f88610a189190610f18565b8f8f610bad565b610a299190610ed9565b610a339190610ef6565b610a3e906001610f2b565b9050808c10610a4f57869350600194505b808c11610a5a578691505b5061099a565b83610a73576000955050505050506105d9565b505050505095945050505050565b610a89610b53565b610a936000610c1a565b565b610a9d610b53565b610aae898989898989898989610c6a565b505050505050505050565b600080610ac78585856105e2565b90506000600154600261036b9190610ed9565b610ae2610b53565b6001600160a01b038116610b475760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b60648201526084016102d8565b610b5081610c1a565b50565b6000546001600160a01b03163314610a935760405162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657260448201526064016102d8565b60006301e13380610bc186868987876103c9565b610bcb9088610ed9565b610bd59190610ef6565b9695505050505050565b600080610bed86868961034a565b90506000610bfc87878a610ab9565b9050818511158015610c0e5750808411155b98975050505050505050565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b88881015610cc95760405162461bcd60e51b815260206004820152602660248201527f426173652052617465205261792065786365656473204f7074696d616c20526160448201526574652052617960d01b60648201526084016102d8565b87871015610d275760405162461bcd60e51b815260206004820152602560248201527f4f7074696d616c2072617465205261792065786365656473204d617820526174604482015264652052617960d81b60648201526084016102d8565b600754821015610d685760405162461bcd60e51b815260206004820152600c60248201526b54203e3d206d61785261746560a01b60448201526064016102d8565b848411610d9f5760405162461bcd60e51b815260206004820152600560248201526426901f102760d91b60448201526064016102d8565b600598909855600696909655600794909455600892909255600a94909455600193909355600292909255600391909155600455565b600060208284031215610de657600080fd5b81356001600160a01b03811681146103c257600080fd5b600080600060608486031215610e1257600080fd5b505081359360208301359350604090920135919050565b600080600080600060a08688031215610e4157600080fd5b505083359560208501359550604085013594606081013594506080013592509050565b60008060008060008060008060006101208a8c031215610e8357600080fd5b505087359960208901359950604089013598606081013598506080810135975060a0810135965060c0810135955060e08101359450610100013592509050565b634e487b7160e01b600052601160045260246000fd5b8082028115828204841417610ef057610ef0610ec3565b92915050565b600082610f1357634e487b7160e01b600052601260045260246000fd5b500490565b81810381811115610ef057610ef0610ec3565b80820180821115610ef057610ef0610ec3565b600060208284031215610f5057600080fd5b505191905056fea2646970667358221220cccd99d59e4ee3ae222c3041b99b2f28ad8dfb44ddbfa3952cfd7ff4c38a11e664736f6c63430008140033000000000000000000000000000000000000000000084595161401484a000000000000000000000000000000000000000000000000108b2a2c2802909400000000000000000000000000000000000000000000000039e7139a8c08fa0600000000000000000000000000000000000000000000000018d0bf423c03d8de0000000000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000f8277896582678ac0000000000000000000000000000000000000000000000019d971e4fe8401e740000000000000000000000000000000000000000000000033b2e3c9fd0803ce8000000"

logging.basicConfig(filename="/tmp/K2_PartitionedLinearInterestRateModel_deployment.log",
                    filemode='a',
                    format='%(asctime)s,%(msecs)d %(name)s %(levelname)s %(message)s',
                    datefmt='%H:%M:%S',
                    level=logging.INFO)

def deploy_K2_PartitionedLinearInterestRateModel() -> (bool, dict):
    
    result = {
        "transaction": {},
        "receipt": {},
        "additional_info": {
            "contract_address": "" # Only populates if the contract was deployed successfully
        }
    }
    
    el_uri = os.getenv("EL_RPC_URI", 'http://0.0.0.0:53913')
    sender = get_sender()
    receiver = "0x0000000000000000000000000000000000000000"
    w3 = Web3(Web3.HTTPProvider(el_uri))
    # sleep for 10s before checking again
    time.sleep(10)
    
    # Check if the chain has started before submitting transactions
    block = w3.eth.get_block('latest')
    
    logging.info(f"Latest block number: {block.number}")
    if block.number > 1:
        logging.info("Chain has started, proceeding with PoN-PartitionedLinearInterestRateModel deployment")
        sender_account = w3.eth.account.from_key(sender)
        
        w3.middleware_onion.add(construct_sign_and_send_raw_middleware(sender_account))
        
        logging.info("Preparing PoN-PartitionedLinearInterestRateModel deployment tx")
        transaction = {
            "from": sender_account.address,
            "to": receiver,
            "value": 0,
            "gasPrice": w3.eth.gas_price,
            'nonce': w3.eth.get_transaction_count(sender_account.address),
            "data": BYTE_CODE
        }
        
        logging.info("Estimating gas")
        estimated_gas = w3.eth.estimate_gas(transaction)
        transaction["gas"] = estimated_gas
        
        logging.info("Sending PoN-PartitionedLinearInterestRateModel deployment tx")
        logging.debug(f"Sending deployment tx: {transaction}")
        tx_hash = w3.eth.send_transaction(transaction)
        
        time.sleep(10)
        PartitionedLinearInterestRateModel_tx = w3.eth.get_transaction(tx_hash)
        PartitionedLinearInterestRateModel_receipt = w3.eth.get_transaction_receipt(tx_hash)
        
        logging.info(f"PoN-PartitionedLinearInterestRateModel deployment tx: {PartitionedLinearInterestRateModel_tx}")
        logging.info(f"PoN-PartitionedLinearInterestRateModel deployment receipt: {PartitionedLinearInterestRateModel_receipt}")
        
        if PartitionedLinearInterestRateModel_receipt['status'] == 1:
            logging.info("PoN-PartitionedLinearInterestRateModel deployment successful")
            result["transaction"] = PartitionedLinearInterestRateModel_tx
            result["receipt"] = PartitionedLinearInterestRateModel_receipt
            result["additional_info"]["contract_address"] = PartitionedLinearInterestRateModel_receipt["contractAddress"]
            return True, result
        else:
            logging.info("PoN-PartitionedLinearInterestRateModel deployment failed")
            return False, result
        
    else:
        logging.info("Chain has not started, restarting deployment")
        return False, {}

def get_sender() -> str:
    # Extract the right private key from the list of private keys
    private_keys = os.getenv("PRIVATE_KEYS", ACCOUNT_ALIAS+":ac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80")
    private_keys.split(";")
    sender = ""
    for key in private_keys:
        if key.split(":")[0] == ACCOUNT_ALIAS:
            sender_keys = key.split(":")[1].split(",")
            sender = sender_keys[0]
            break
    return sender

def run_till_deployed() -> dict:
    deployment_status = False
    deployment_details = {}
    while deployment_status is False:
        try:
          deployment_status, deployment_details = deploy_K2_PartitionedLinearInterestRateModel()
        except Exception as e:
          logging.error(e)
          logging.error("restarting deployment as previous one failed")
    
    return deployment_details


if __name__ == "__main__":
    
    logging.info("PoN-PartitionedLinearInterestRateModel deployment started")
    deployment_details = run_till_deployed()
    logging.info("PoN-PartitionedLinearInterestRateModel deployment finished")
    
    print(deployment_details)
