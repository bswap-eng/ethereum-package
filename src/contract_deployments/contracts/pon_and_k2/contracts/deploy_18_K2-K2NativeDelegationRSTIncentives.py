from web3 import Web3
from web3.middleware import construct_sign_and_send_raw_middleware
import os
import time
import logging

# Account Alias: PON
ACCOUNT_ALIAS = "PON"

# K2NativeDelegationRSTIncentives contract bytecode
BYTE_CODE = "0x60a0604052306080523480156200001557600080fd5b506200002062000026565b620000e7565b600054610100900460ff1615620000935760405162461bcd60e51b815260206004820152602760248201527f496e697469616c697a61626c653a20636f6e747261637420697320696e697469604482015266616c697a696e6760c81b606482015260840160405180910390fd5b60005460ff90811614620000e5576000805460ff191660ff9081179091556040519081527f7f26b83ff96e1f2b6a682f133852f6798a09c465da95921460cefb38474024989060200160405180910390a15b565b60805161314c6200011f600039600081816108400152818161088901528181610ea401528181610ee40152611025015261314c6000f3fe6080604052600436106101ee5760003560e01c80638da5cb5b1161010d578063d18df53c116100a0578063ddf107eb1161006f578063ddf107eb146105e1578063e2bbb15814610601578063e8f8708f14610621578063f0f4426014610641578063f2fde38b1461066157600080fd5b8063d18df53c14610557578063d2f705f014610577578063d696f77f146105a4578063d71be6a6146105c157600080fd5b8063b8caed84116100dc578063b8caed84146104ca578063bd85b039146104ea578063c1042bb814610517578063c19f5f401461053757600080fd5b80638da5cb5b1461041a57806393f1a40b14610438578063aaf5eb681461048c578063b0bb0031146104aa57600080fd5b8063485cc9551161018557806361d027b31161015457806361d027b314610398578063630b5ba1146103d05780636cef617b146103e5578063715018a61461040557600080fd5b8063485cc955146103305780634f1ef2861461035057806351eb05a61461036357806352d1902d1461038357600080fd5b8063379607f5116101c1578063379607f5146102b05780633bd1968f146102d0578063441a3e70146102f0578063455ce75a1461031057600080fd5b8063081e3eda146101f35780630fcc56f7146102175780631526fe27146102395780633659cfe614610290575b600080fd5b3480156101ff57600080fd5b5060ca545b6040519081526020015b60405180910390f35b34801561022357600080fd5b50610237610232366004612bcc565b610681565b005b34801561024557600080fd5b50610259610254366004612bcc565b6107e6565b604080516001600160a01b0390971687526020870195909552938501929092526060840152608083015260a082015260c00161020e565b34801561029c57600080fd5b506102376102ab366004612bfa565b610836565b3480156102bc57600080fd5b506102376102cb366004612bcc565b61091e565b3480156102dc57600080fd5b506102046102eb366004612bfa565b610a64565b3480156102fc57600080fd5b5061023761030b366004612c17565b610a8f565b34801561031c57600080fd5b5061023761032b366004612bcc565b610c97565b34801561033c57600080fd5b5061023761034b366004612c39565b610d86565b61023761035e366004612c88565b610e9a565b34801561036f57600080fd5b5061023761037e366004612bcc565b610f6a565b34801561038f57600080fd5b50610204611018565b3480156103a457600080fd5b5060c9546103b8906001600160a01b031681565b6040516001600160a01b03909116815260200161020e565b3480156103dc57600080fd5b506102376110cb565b3480156103f157600080fd5b50610237610400366004612bcc565b6110f2565b34801561041157600080fd5b5061023761140b565b34801561042657600080fd5b506033546001600160a01b03166103b8565b34801561044457600080fd5b50610477610453366004612d4c565b60cc6020908152600092835260408084209091529082529020805460019091015482565b6040805192835260208301919091520161020e565b34801561049857600080fd5b5061020469021e19e0c9bab240000081565b3480156104b657600080fd5b506102376104c5366004612d7f565b61141f565b3480156104d657600080fd5b506102046104e5366004612c17565b611607565b3480156104f657600080fd5b50610204610505366004612bcc565b60cd6020526000908152604090205481565b34801561052357600080fd5b50610237610532366004612dad565b505050565b34801561054357600080fd5b50610237610552366004612bcc565b6116e0565b34801561056357600080fd5b50610204610572366004612d4c565b611876565b34801561058357600080fd5b50610204610592366004612bfa565b60ce6020526000908152604090205481565b3480156105b057600080fd5b5061020468014d1120d7b160000081565b3480156105cd57600080fd5b506102376105dc366004612de2565b61195a565b3480156105ed57600080fd5b506102376105fc366004612e38565b611d95565b34801561060d57600080fd5b5061023761061c366004612c17565b612155565b34801561062d57600080fd5b5060cf546103b8906001600160a01b031681565b34801561064d57600080fd5b5061023761065c366004612bfa565b612392565b34801561066d57600080fd5b5061023761067c366004612bfa565b6123bc565b33600090815260ce6020526040902054156106af5760405163779b1c9560e11b815260040160405180910390fd5b600081815260cc60209081526040808320338452909152812080549091036106ea5760405163162908e360e11b815260040160405180910390fd5b61077a33826000015460cf60009054906101000a90046001600160a01b03166001600160a01b03166395e97eee6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610746573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061076a9190612e82565b6001600160a01b03169190612432565b8054604051908152829033907fb7d1985cfb8474236c8f961757e5a325c5445fcb92e8515dbcf4f1bd17d895409060200160405180910390a38054600083815260cd6020526040812080549091906107d3908490612eb5565b9091555050600080825560019091015550565b60ca81815481106107f657600080fd5b60009182526020909120600690910201805460018201546002830154600384015460048501546005909501546001600160a01b0390941695509193909286565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001630036108875760405162461bcd60e51b815260040161087e90612ec8565b60405180910390fd5b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03166108d06000805160206130d0833981519152546001600160a01b031690565b6001600160a01b0316146108f65760405162461bcd60e51b815260040161087e90612f14565b6108ff81612495565b6040805160008082526020820190925261091b9183919061249d565b50565b600060ca828154811061093357610933612f60565b90600052602060002090600602019050438160030154111561096857604051633fe218a360e11b815260040160405180910390fd5b61097182610f6a565b600082815260cc60209081526040808320338452909152812060018101546002840154825492939269021e19e0c9bab2400000916109ae91612f76565b6109b89190612f8d565b6109c29190612eb5565b9050806000036109e557604051630fec21fd60e21b815260040160405180910390fd5b82546109fb906001600160a01b03163383612432565b6002830154825469021e19e0c9bab240000091610a1791612f76565b610a219190612f8d565b6001830155604051818152849033907f34fcbac0073d7c3d388e51312faf357774904998eeb8fca628b9e6f65ee1cbf7906020015b60405180910390a350505050565b6001600160a01b038116600090815260cb6020526040812054610a8990600190612eb5565b92915050565b80600003610ab05760405163162908e360e11b815260040160405180910390fd5b600060ca8381548110610ac557610ac5612f60565b906000526020600020906006020190504381600301541115610afa57604051633fe218a360e11b815260040160405180910390fd5b600083815260cc6020908152604080832033845290915290208054831115610b355760405163162908e360e11b815260040160405180910390fd5b610b3e84610f6a565b6000816001015469021e19e0c9bab240000084600201548460000154610b649190612f76565b610b6e9190612f8d565b610b789190612eb5565b90508015610b96578254610b96906001600160a01b03163383612432565b600085815260cd602052604081208054869290610bb4908490612eb5565b9091555050815484908390600090610bcd908490612eb5565b90915550506002830154825469021e19e0c9bab240000091610bee91612f76565b610bf89190612f8d565b8260010181905550610c58338560cf60009054906101000a90046001600160a01b03166001600160a01b03166395e97eee6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610746573d6000803e3d6000fd5b604051848152859033907ff279e6a1f5e320cca91135676d9cb6e44ca8a08c0b88342bcdb1144f6511b568906020015b60405180910390a35050505050565b610ca2816001612faf565b33600090815260ce602052604090205414610cd0576040516330d9f64960e01b815260040160405180910390fd5b600081815260cc6020908152604080832033845290915281208054909103610d0b5760405163162908e360e11b815260040160405180910390fd5b8054604051908152829033907fb7d1985cfb8474236c8f961757e5a325c5445fcb92e8515dbcf4f1bd17d895409060200160405180910390a38054600083815260cd602052604081208054909190610d64908490612eb5565b90915550506000808255600190910181905533815260ce602052604081205550565b600054610100900460ff1615808015610da65750600054600160ff909116105b80610dc05750303b158015610dc0575060005460ff166001145b610e235760405162461bcd60e51b815260206004820152602e60248201527f496e697469616c697a61626c653a20636f6e747261637420697320616c72656160448201526d191e481a5b9a5d1a585b1a5e995960921b606482015260840161087e565b6000805460ff191660011790558015610e46576000805461ff0019166101001790555b610e508383612608565b8015610532576000805461ff0019169055604051600181527f7f26b83ff96e1f2b6a682f133852f6798a09c465da95921460cefb38474024989060200160405180910390a1505050565b6001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000163003610ee25760405162461bcd60e51b815260040161087e90612ec8565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316610f2b6000805160206130d0833981519152546001600160a01b031690565b6001600160a01b031614610f515760405162461bcd60e51b815260040161087e90612f14565b610f5a82612495565b610f668282600161249d565b5050565b600060ca8281548110610f7f57610f7f612f60565b9060005260206000209060060201905080600101544311610f9e575050565b600082815260cd602052604081205490819003610fc057504360019091015550565b6000610fd0848460010154611607565b905081610fe769021e19e0c9bab240000083612f76565b610ff19190612f8d565b8360020160008282546110049190612faf565b909155505043600190930192909255505050565b6000306001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146110b85760405162461bcd60e51b815260206004820152603860248201527f555550535570677261646561626c653a206d757374206e6f742062652063616c60448201527f6c6564207468726f7567682064656c656761746563616c6c0000000000000000606482015260840161087e565b506000805160206130d083398151915290565b60ca5460005b81811015610f66576110e281610f6a565b6110eb81612fc2565b90506110d1565b600060ca828154811061110757611107612f60565b90600052602060002090600602019050438160030154111561113c57604051633fe218a360e11b815260040160405180910390fd5b33600090815260ce6020526040902054158015906111735750611160826001612faf565b33600090815260ce602052604090205414155b15611191576040516330d9f64960e01b815260040160405180910390fd5b61119a82610f6a565b600082815260cc6020908152604080832033845290915290208054158015906111d0575033600090815260ce6020526040902054155b156111ee576040516330d9f64960e01b815260040160405180910390fd5b80541561124f576000816001015469021e19e0c9bab24000008460020154846000015461121b9190612f76565b6112259190612f8d565b61122f9190612eb5565b9050801561124d57825461124d906001600160a01b03163383612432565b505b60cf546040516338e135b360e01b81523360048201526000916001600160a01b0316906338e135b390602401602060405180830381865afa158015611298573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906112bc9190612fdb565b82549091506112d468014d1120d7b160000083612f76565b116112f25760405163162908e360e11b815260040160405180910390fd5b815460009061130b9068014d1120d7b160000090612f8d565b6113159083612eb5565b9050600061132c68014d1120d7b160000083612f76565b90508060cd600088815260200190815260200160002060008282546113519190612faf565b909155505083548190859060009061136a908490612faf565b90915550506002850154845469021e19e0c9bab24000009161138b91612f76565b6113959190612f8d565b600185015533600090815260ce602052604081205490036113cc576113bb866001612faf565b33600090815260ce60205260409020555b604051818152869033907f90890809c654f11d6e72a28fa60149770a0d11ec6c92319d6ceb2bb0a4ea1a159060200160405180910390a3505050505050565b611413612663565b61141d60006126bd565b565b611427612663565b6001600160a01b038216600090815260cb60205260409020541561145e57604051634c8cc6d160e11b815260040160405180910390fd5b801561146c5761146c6110cb565b6040805160c0810182526001600160a01b038481168083524360208085019182526000858701818152606087018281526080880183815260a0890184815260ca8054600180820183558288529b517f42d72674974f694b5f5159593243114d38a5c39c89d6b62fee061ff523240ee1600690920291820180546001600160a01b03191691909c1617909a5596517f42d72674974f694b5f5159593243114d38a5c39c89d6b62fee061ff523240ee28a015592517f42d72674974f694b5f5159593243114d38a5c39c89d6b62fee061ff523240ee389015590517f42d72674974f694b5f5159593243114d38a5c39c89d6b62fee061ff523240ee4880155517f42d72674974f694b5f5159593243114d38a5c39c89d6b62fee061ff523240ee5870155517f42d72674974f694b5f5159593243114d38a5c39c89d6b62fee061ff523240ee690950194909455905491835260cb90529290208290556115cf91612eb5565b6040516001600160a01b038416907ff5d252583cd714facf6cafc09e6ed202a7cb8f2ceec3d3b9102b12b0fe4d4be690600090a35050565b600080829050600060ca858154811061162257611622612f60565b906000526020600020906006020160030154905080821015611642578091505b6000439050600060ca878154811061165c5761165c612f60565b906000526020600020906006020160040154836116799190612faf565b905080821115611687578091505b8382101561169c576000945050505050610a89565b6116a68483612eb5565b60ca88815481106116b9576116b9612f60565b9060005260206000209060060201600501546116d59190612f76565b979650505050505050565b600060ca82815481106116f5576116f5612f60565b90600052602060002090600602019050438160030154111561172a57604051633fe218a360e11b815260040160405180910390fd5b600082815260cc60209081526040808320338452909152812080549091036117655760405163162908e360e11b815260040160405180910390fd5b61176e83610f6a565b6000816001015469021e19e0c9bab2400000846002015484600001546117949190612f76565b61179e9190612f8d565b6117a89190612eb5565b905080156117c65782546117c6906001600160a01b03163383612432565b8154600085815260cd6020526040812080548392906117e6908490612eb5565b90915550508254819084906000906117ff908490612eb5565b90915550506002840154835469021e19e0c9bab24000009161182091612f76565b61182a9190612f8d565b600184015533600081815260ce602052604080822091909155518691907ff279e6a1f5e320cca91135676d9cb6e44ca8a08c0b88342bcdb1144f6511b56890610c889085815260200190565b60008060ca848154811061188c5761188c612f60565b6000918252602080832087845260cc825260408085206001600160a01b03891686528352808520600260069095029092019384015489865260cd9093529093205460018301549294509091431180156118e457508015155b156119285760006118f9888660010154611607565b90508161191069021e19e0c9bab240000083612f76565b61191a9190612f8d565b6119249084612faf565b9250505b6001830154835469021e19e0c9bab240000090611946908590612f76565b6119509190612f8d565b6116d59190612eb5565b611962612663565b8015611970576119706110cb565b6001600160a01b038516600090815260cb602052604081205490036119a85760405163dfde867160e01b815260040160405180910390fd5b6001600160a01b038516600090815260cb60205260408120546119cd90600190612eb5565b90506119d881610f6a565b600060ca82815481106119ed576119ed612f60565b9060005260206000209060060201600301549050600081118015611a115750438111155b15611a3b57858114611a365760405163ec2caa0d60e01b815260040160405180910390fd5b611a5c565b43861015611a5c5760405163ec2caa0d60e01b815260040160405180910390fd5b80600003611acb578560ca8381548110611a7857611a78612f60565b906000526020600020906006020160030181905550859050817f5a7d5f50ab70a39d193bf53f0fb995377776df93bb6fdcf1cd1868b7e0dd44ee87604051611ac291815260200190565b60405180910390a25b83600003611aec57604051633dea3a3b60e11b815260040160405180910390fd5b84600003611b0d5760405163162908e360e11b815260040160405180910390fd5b438111158015611b40575060ca8281548110611b2b57611b2b612f60565b90600052602060002090600602016004015484105b15611b5e57604051633dea3a3b60e11b815260040160405180910390fd5b600081431115611bd85760ca8381548110611b7b57611b7b612f60565b90600052602060002090600602016004015482611b989190612faf565b431115611bcb5760ca8381548110611bb257611bb2612f60565b9060005260206000209060060201600401549050611bd8565b611bd58243612eb5565b90505b60008160ca8581548110611bee57611bee612f60565b906000526020600020906006020160040154611c0a9190612eb5565b60ca8581548110611c1d57611c1d612f60565b906000526020600020906006020160050154611c399190612f76565b90506000611c478888612f76565b905043611c54888b612faf565b11611c6157506000611c8b565b43891015611c8b5787611c748a43612eb5565b611c7e9190612f76565b611c889082612eb5565b90505b81811115611cc05760c954611cc0906001600160a01b031630611cae8585612eb5565b6001600160a01b038e1692919061270f565b81811015611cf35760c954611cf3906001600160a01b0316611ce28385612eb5565b6001600160a01b038d169190612432565b8760ca8681548110611d0757611d07612f60565b9060005260206000209060060201600501819055508660ca8681548110611d3057611d30612f60565b6000918252602090912060046006909202010155847f7f00a34ff31e4c391e9c1229fe7e10914ffd4db7d106f294727b16d147a51b5889611d718a8d612faf565b6040805192835260208301919091520160405180910390a250505050505050505050565b60cf546001600160a01b03163314611ddf5760405162461bcd60e51b815260206004820152600d60248201526c4f6e6c7920726567697374727960981b604482015260640161087e565b6001600160a01b038416600090815260ce6020526040902054801561214d576000611e0b600183612eb5565b9050600060ca8281548110611e2257611e22612f60565b906000526020600020906006020190504381600301541115611e465750505061214f565b611e4f82610f6a565b600082815260cc602090815260408083206001600160a01b038b168452909152812060018101546002840154825492939269021e19e0c9bab240000091611e9591612f76565b611e9f9190612f8d565b611ea99190612eb5565b90508015611fbb5760cf5460408051634af4bf7760e11b815290516000926001600160a01b0316916395e97eee9160048083019260209291908290030181865afa158015611efb573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611f1f9190612e82565b90508615611fa357611f9e816001600160a01b0316632131c68c6040518163ffffffff1660e01b8152600401602060405180830381865afa158015611f68573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611f8c9190612e82565b85546001600160a01b03169084612432565b611fb9565b8354611fb9906001600160a01b03168b84612432565b505b6002830154825469021e19e0c9bab240000091611fd791612f76565b611fe19190612f8d565b600183015560405181815284906001600160a01b038b16907f34fcbac0073d7c3d388e51312faf357774904998eeb8fca628b9e6f65ee1cbf79060200160405180910390a3600088600003612051575081546001600160a01b038a16600090815260ce60205260408120556120a0565b825460009061206a9068014d1120d7b160000090612f8d565b90506000818b1061207c576000612086565b6120868b83612eb5565b905061209b8168014d1120d7b1600000612f76565b925050505b600085815260cd6020526040812080548392906120be908490612eb5565b90915550508254819084906000906120d7908490612eb5565b90915550506002840154835469021e19e0c9bab2400000916120f891612f76565b6121029190612f8d565b600184015560405181815285906001600160a01b038c16907ff279e6a1f5e320cca91135676d9cb6e44ca8a08c0b88342bcdb1144f6511b5689060200160405180910390a350505050505b505b50505050565b806000036121765760405163162908e360e11b815260040160405180910390fd5b33600090815260ce6020526040902054156121a45760405163779b1c9560e11b815260040160405180910390fd5b600060ca83815481106121b9576121b9612f60565b9060005260206000209060060201905043816003015411156121ee57604051633fe218a360e11b815260040160405180910390fd5b6121f783610f6a565b600083815260cc602090815260408083203384529091529020805415612271576000816001015469021e19e0c9bab24000008460020154846000015461223d9190612f76565b6122479190612f8d565b6122519190612eb5565b9050801561226f57825461226f906001600160a01b03163383612432565b505b600084815260cd60205260408120805485929061228f908490612faf565b90915550508054839082906000906122a8908490612faf565b90915550506002820154815469021e19e0c9bab2400000916122c991612f76565b6122d39190612f8d565b600182015560cf5460408051634af4bf7760e11b8152905161235e923392309288926001600160a01b0316916395e97eee9160048083019260209291908290030181865afa158015612329573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061234d9190612e82565b6001600160a01b031692919061270f565b604051838152849033907f90890809c654f11d6e72a28fa60149770a0d11ec6c92319d6ceb2bb0a4ea1a1590602001610a56565b61239a612663565b60c980546001600160a01b0319166001600160a01b0392909216919091179055565b6123c4612663565b6001600160a01b0381166124295760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b606482015260840161087e565b61091b816126bd565b6040516001600160a01b03831660248201526044810182905261053290849063a9059cbb60e01b906064015b60408051601f198184030181529190526020810180516001600160e01b03166001600160e01b031990931692909217909152612747565b61091b612663565b7f4910fdfa16fed3260ed0e7147f7cc6da11a60208b5b9406d12a635614ffd91435460ff16156124d0576105328361281c565b826001600160a01b03166352d1902d6040518163ffffffff1660e01b8152600401602060405180830381865afa92505050801561252a575060408051601f3d908101601f1916820190925261252791810190612fdb565b60015b61258d5760405162461bcd60e51b815260206004820152602e60248201527f45524331393637557067726164653a206e657720696d706c656d656e7461746960448201526d6f6e206973206e6f74205555505360901b606482015260840161087e565b6000805160206130d083398151915281146125fc5760405162461bcd60e51b815260206004820152602960248201527f45524331393637557067726164653a20756e737570706f727465642070726f786044820152681a58589b195555525160ba1b606482015260840161087e565b506105328383836128b8565b600054610100900460ff1661262f5760405162461bcd60e51b815260040161087e90612ff4565b6126376128dd565b61263f61290c565b60cf80546001600160a01b0319166001600160a01b038316179055610f66826123bc565b6033546001600160a01b0316331461141d5760405162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572604482015260640161087e565b603380546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b6040516001600160a01b038085166024830152831660448201526064810182905261214f9085906323b872dd60e01b9060840161245e565b600061279c826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b03166129339092919063ffffffff16565b90508051600014806127bd5750808060200190518101906127bd919061303f565b6105325760405162461bcd60e51b815260206004820152602a60248201527f5361666545524332303a204552433230206f7065726174696f6e20646964206e6044820152691bdd081cdd58d8d9595960b21b606482015260840161087e565b6001600160a01b0381163b6128895760405162461bcd60e51b815260206004820152602d60248201527f455243313936373a206e657720696d706c656d656e746174696f6e206973206e60448201526c1bdd08184818dbdb9d1c9858dd609a1b606482015260840161087e565b6000805160206130d083398151915280546001600160a01b0319166001600160a01b0392909216919091179055565b6128c18361294a565b6000825111806128ce5750805b156105325761214f838361298a565b600054610100900460ff166129045760405162461bcd60e51b815260040161087e90612ff4565b61141d6129b6565b600054610100900460ff1661141d5760405162461bcd60e51b815260040161087e90612ff4565b606061294284846000856129e6565b949350505050565b6129538161281c565b6040516001600160a01b038216907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a250565b60606129af83836040518060600160405280602781526020016130f060279139612ab6565b9392505050565b600054610100900460ff166129dd5760405162461bcd60e51b815260040161087e90612ff4565b61141d336126bd565b606082471015612a475760405162461bcd60e51b815260206004820152602660248201527f416464726573733a20696e73756666696369656e742062616c616e636520666f6044820152651c8818d85b1b60d21b606482015260840161087e565b600080866001600160a01b03168587604051612a639190613080565b60006040518083038185875af1925050503d8060008114612aa0576040519150601f19603f3d011682016040523d82523d6000602084013e612aa5565b606091505b50915091506116d587838387612b2e565b6060600080856001600160a01b031685604051612ad39190613080565b600060405180830381855af49150503d8060008114612b0e576040519150601f19603f3d011682016040523d82523d6000602084013e612b13565b606091505b5091509150612b2486838387612b2e565b9695505050505050565b60608315612b9d578251600003612b96576001600160a01b0385163b612b965760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e7472616374000000604482015260640161087e565b5081612942565b6129428383815115612bb25781518083602001fd5b8060405162461bcd60e51b815260040161087e919061309c565b600060208284031215612bde57600080fd5b5035919050565b6001600160a01b038116811461091b57600080fd5b600060208284031215612c0c57600080fd5b81356129af81612be5565b60008060408385031215612c2a57600080fd5b50508035926020909101359150565b60008060408385031215612c4c57600080fd5b8235612c5781612be5565b91506020830135612c6781612be5565b809150509250929050565b634e487b7160e01b600052604160045260246000fd5b60008060408385031215612c9b57600080fd5b8235612ca681612be5565b9150602083013567ffffffffffffffff80821115612cc357600080fd5b818501915085601f830112612cd757600080fd5b813581811115612ce957612ce9612c72565b604051601f8201601f19908116603f01168101908382118183101715612d1157612d11612c72565b81604052828152886020848701011115612d2a57600080fd5b8260208601602083013760006020848301015280955050505050509250929050565b60008060408385031215612d5f57600080fd5b823591506020830135612c6781612be5565b801515811461091b57600080fd5b60008060408385031215612d9257600080fd5b8235612d9d81612be5565b91506020830135612c6781612d71565b600080600060608486031215612dc257600080fd5b8335612dcd81612be5565b95602085013595506040909401359392505050565b600080600080600060a08688031215612dfa57600080fd5b8535612e0581612be5565b94506020860135935060408601359250606086013591506080860135612e2a81612d71565b809150509295509295909350565b60008060008060808587031215612e4e57600080fd5b8435612e5981612be5565b935060208501359250604085013591506060850135612e7781612d71565b939692955090935050565b600060208284031215612e9457600080fd5b81516129af81612be5565b634e487b7160e01b600052601160045260246000fd5b81810381811115610a8957610a89612e9f565b6020808252602c908201527f46756e6374696f6e206d7573742062652063616c6c6564207468726f7567682060408201526b19195b1959d85d1958d85b1b60a21b606082015260800190565b6020808252602c908201527f46756e6374696f6e206d7573742062652063616c6c6564207468726f7567682060408201526b6163746976652070726f787960a01b606082015260800190565b634e487b7160e01b600052603260045260246000fd5b8082028115828204841417610a8957610a89612e9f565b600082612faa57634e487b7160e01b600052601260045260246000fd5b500490565b80820180821115610a8957610a89612e9f565b600060018201612fd457612fd4612e9f565b5060010190565b600060208284031215612fed57600080fd5b5051919050565b6020808252602b908201527f496e697469616c697a61626c653a20636f6e7472616374206973206e6f74206960408201526a6e697469616c697a696e6760a81b606082015260800190565b60006020828403121561305157600080fd5b81516129af81612d71565b60005b8381101561307757818101518382015260200161305f565b50506000910152565b6000825161309281846020870161305c565b9190910192915050565b60208152600082518060208401526130bb81604085016020870161305c565b601f01601f1916919091016040019291505056fe360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c6564a2646970667358221220a1294c2bcecd3b0aff782970d9506fde8a169fa7101ab616424deba15c46d59264736f6c63430008140033"

logging.basicConfig(filename="/tmp/K2_K2NativeDelegationRSTIncentives_deployment.log",
                    filemode='a',
                    format='%(asctime)s,%(msecs)d %(name)s %(levelname)s %(message)s',
                    datefmt='%H:%M:%S',
                    level=logging.INFO)

def deploy_K2_K2NativeDelegationRSTIncentives() -> (bool, dict):
    
    result = {
        "transaction": {},
        "receipt": {},
        "additional_info": {
            "contract_address": "" # Only populates if the contract was deployed successfully
        }
    }
    
    el_uri = os.getenv("EL_RPC_URI", 'http://0.0.0.0:53913')
    sender = get_sender()
    receiver = "0x0000000000000000000000000000000000000000"
    w3 = Web3(Web3.HTTPProvider(el_uri))
    # sleep for 10s before checking again
    time.sleep(10)
    
    # Check if the chain has started before submitting transactions
    block = w3.eth.get_block('latest')
    
    logging.info(f"Latest block number: {block.number}")
    if block.number > 1:
        logging.info("Chain has started, proceeding with PoN-K2NativeDelegationRSTIncentives deployment")
        sender_account = w3.eth.account.from_key(sender)
        
        w3.middleware_onion.add(construct_sign_and_send_raw_middleware(sender_account))
        
        logging.info("Preparing PoN-K2NativeDelegationRSTIncentives deployment tx")
        transaction = {
            "from": sender_account.address,
            "to": receiver,
            "value": 0,
            "gasPrice": w3.eth.gas_price,
            'nonce': w3.eth.get_transaction_count(sender_account.address),
            "data": BYTE_CODE
        }
        
        logging.info("Estimating gas")
        estimated_gas = w3.eth.estimate_gas(transaction)
        transaction["gas"] = estimated_gas
        
        logging.info("Sending PoN-K2NativeDelegationRSTIncentives deployment tx")
        logging.debug(f"Sending deployment tx: {transaction}")
        tx_hash = w3.eth.send_transaction(transaction)
        
        time.sleep(10)
        K2NativeDelegationRSTIncentives_tx = w3.eth.get_transaction(tx_hash)
        K2NativeDelegationRSTIncentives_receipt = w3.eth.get_transaction_receipt(tx_hash)
        
        logging.info(f"PoN-K2NativeDelegationRSTIncentives deployment tx: {K2NativeDelegationRSTIncentives_tx}")
        logging.info(f"PoN-K2NativeDelegationRSTIncentives deployment receipt: {K2NativeDelegationRSTIncentives_receipt}")
        
        if K2NativeDelegationRSTIncentives_receipt['status'] == 1:
            logging.info("PoN-K2NativeDelegationRSTIncentives deployment successful")
            result["transaction"] = K2NativeDelegationRSTIncentives_tx
            result["receipt"] = K2NativeDelegationRSTIncentives_receipt
            result["additional_info"]["contract_address"] = K2NativeDelegationRSTIncentives_receipt["contractAddress"]
            return True, result
        else:
            logging.info("PoN-K2NativeDelegationRSTIncentives deployment failed")
            return False, result
        
    else:
        logging.info("Chain has not started, restarting deployment")
        return False, {}

def get_sender() -> str:
    # Extract the right private key from the list of private keys
    private_keys = os.getenv("PRIVATE_KEYS", ACCOUNT_ALIAS+":ac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80")
    private_keys.split(";")
    sender = ""
    for key in private_keys:
        if key.split(":")[0] == ACCOUNT_ALIAS:
            sender_keys = key.split(":")[1].split(",")
            sender = sender_keys[0]
            break
    return sender

def run_till_deployed() -> dict:
    deployment_status = False
    deployment_details = {}
    while deployment_status is False:
        try:
          deployment_status, deployment_details = deploy_K2_K2NativeDelegationRSTIncentives()
        except Exception as e:
          logging.error(e)
          logging.error("restarting deployment as previous one failed")
    
    return deployment_details


if __name__ == "__main__":
    
    logging.info("PoN-K2NativeDelegationRSTIncentives deployment started")
    deployment_details = run_till_deployed()
    logging.info("PoN-K2NativeDelegationRSTIncentives deployment finished")
    
    print(deployment_details)
